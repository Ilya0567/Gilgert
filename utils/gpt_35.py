from openai import OpenAI
from utils.config import OPENAI_API_KEY
import openai
import json
import re
from typing import Optional, Dict, Any, List

client = OpenAI(api_key=OPENAI_API_KEY)

# –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–±–æ—Ç—ã –º–æ–¥–µ–ª–∏
SYSTEM_MESSAGE = """–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∑–¥–æ—Ä–æ–≤—å—é –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—é, –∫–æ—Ç–æ—Ä—ã–π –æ–±—â–∞–µ—Ç—Å—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –æ–±—â–µ–Ω–∏–µ –±–æ–ª–µ–µ –∂–∏–≤—ã–º üòä
- –û–±—â–∞–π—Å—è –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, –∫–æ–≥–¥–∞ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ
- –ë—É–¥—å —ç–º–ø–∞—Ç–∏—á–Ω—ã–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–π —Å–≤–æ—é –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∑–≤–µ–∑–¥–æ—á–∫–∏ (*) –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
- –î–∞–≤–∞–π —á–µ—Ç–∫–∏–µ –∏ –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–æ–ª–æ–¥–µ–∂–Ω—ã–π —Å–ª–µ–Ω–≥, –µ—Å–ª–∏ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
- –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π —Ç–æ–Ω

–¢—ã –æ—Ç–≤–µ—á–∞–µ—à—å –¢–û–õ–¨–ö–û –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ —Ç–µ–º–∞–º–∏:
- –ó–¥–æ—Ä–æ–≤—å–µ –∏ –º–µ–¥–∏—Ü–∏–Ω–∞
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ
- –§–∏—Ç–Ω–µ—Å –∏ —Å–ø–æ—Ä—Ç
- –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–π
- –õ–µ–∫–∞—Ä—Å—Ç–≤–∞ –∏ –∏—Ö –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
- –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ
- –ó–¥–æ—Ä–æ–≤—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ä–µ—Ü–µ–ø—Ç–∞—Ö, –∑–¥–æ—Ä–æ–≤–æ–º –ø–∏—Ç–∞–Ω–∏–∏, –¥–∏–µ—Ç–∞—Ö –∏–ª–∏ –ø—Ä–æ—Å–∏—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –±–ª—é–¥, –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é show_healthy_recipes –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é —Å —Ä–µ—Ü–µ–ø—Ç–∞–º–∏.

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ —Ç–µ–º–∞–º–∏, –≤–µ–∂–ª–∏–≤–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ –º–æ–∂–µ—à—å –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –∑–¥–æ—Ä–æ–≤—å—è –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–∑ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏."""

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
FUNCTIONS = [
    {
        "name": "show_healthy_recipes",
        "description": "–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Å –ø–æ–¥–±–æ—Ä–∫–æ–π –∑–¥–æ—Ä–æ–≤—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é",
        "parameters": {
            "type": "object",
            "properties": {},
            "required": []
        }
    }
]

class ChatGPTClient:
    def __init__(self, api_key=None, model="gpt-3.5-turbo", temperature=0.9, max_tokens=2000):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ ChatGPT.

        :param api_key: API-–∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ OpenAI (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
        :param model: –ú–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "gpt-3.5-turbo")
        :param temperature: –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (—É–≤–µ–ª–∏—á–µ–Ω–∞ –¥–ª—è –±–æ–ª–µ–µ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)
        :param max_tokens: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
        """
        self.api_key = api_key or OPENAI_API_KEY
        self.client = OpenAI(api_key=self.api_key)
        self.model = model
        self.temperature = temperature
        self.max_tokens = max_tokens

    def generate_response(self, user_message: str, system_message: dict = None, message_history: list = None) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_message (str): –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            system_message (dict, optional): –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SYSTEM_MESSAGE.
            message_history (list, optional): –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é None.
            
        Returns:
            str: –û—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏
        """
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        messages = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if system_message is None:
            messages.append({"role": "system", "content": SYSTEM_MESSAGE})
        else:
            if isinstance(system_message, str):
                messages.append({"role": "system", "content": system_message})
            else:
                messages.append(system_message)
                
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        if message_history:
            messages.extend(message_history)
                
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        messages.append({"role": "user", "content": user_message})
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=self.temperature,
                max_tokens=self.max_tokens,
                functions=FUNCTIONS,
                function_call="auto"
            )
            
            response_message = response.choices[0].message
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–∑–≤–∞–ª –ª–∏ –º–æ–¥–µ–ª—å —Ñ—É–Ω–∫—Ü–∏—é
            if hasattr(response_message, 'function_call') and response_message.function_call:
                function_call = response_message.function_call
                
                # –ï—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤
                if function_call.name == "show_healthy_recipes":
                    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ
                    return "FUNCTION_CALL:show_healthy_recipes"
            
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
            response_text = response_message.content.strip()
            
            # –£–¥–∞–ª—è–µ–º –∑–≤–µ–∑–¥–æ—á–∫–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
            response_text = re.sub(r'\*', '', response_text)
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
            return response_text
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {e}")
            return "–ò–∑–≤–∏–Ω–∏, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ üòî –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!"

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    
    KEY = "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"

    client = ChatGPTClient(api_key=KEY)

    user_input = "–ß—Ç–æ —Ç–∞–∫–æ–µ —Å–∏–Ω–¥—Ä–æ–º —Å–æ–±–∞–∫–∞?"
    response = client.generate_response(system_message=SYSTEM_MESSAGE, user_message=user_input)
    print(response)
    


