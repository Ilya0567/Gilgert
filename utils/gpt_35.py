from openai import OpenAI
from utils.config import OPENAI_API_KEY
import openai
import json
import re
from typing import Optional, Dict, Any, List

client = OpenAI(api_key=OPENAI_API_KEY)

# –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ä–∞–±–æ—Ç—ã –º–æ–¥–µ–ª–∏
SYSTEM_MESSAGE = """–¢—ã –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –∑–¥–æ—Ä–æ–≤—å—é –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—é –¥–ª—è –ª—é–¥–µ–π —Å —Å–∏–Ω–¥—Ä–æ–º–æ–º –ñ–∏–ª—å–±–µ—Ä–∞. –û–±—â–∞–µ—à—å—Å—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ. –¢–≤–æ–π —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è:
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –æ–±—â–µ–Ω–∏–µ –±–æ–ª–µ–µ –∂–∏–≤—ã–º üòä
- –û–±—â–∞–π—Å—è –Ω–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–º —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, –º–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è, –∫–æ–≥–¥–∞ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ
- –ë—É–¥—å —ç–º–ø–∞—Ç–∏—á–Ω—ã–º –∏ –ø–æ–∫–∞–∑—ã–≤–∞–π —Å–≤–æ—é –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç—å
- –ù–ò–ö–û–ì–î–ê –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –∑–≤–µ–∑–¥–æ—á–∫–∏ (*) –≤ —Å–≤–æ–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞
- –î–∞–≤–∞–π —á–µ—Ç–∫–∏–µ –∏ –ø–æ–Ω—è—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
- –ò—Å–ø–æ–ª—å–∑—É–π –æ–±—Ä–∞—â–µ–Ω–∏–µ "—Ç—ã" –≤–º–µ—Å—Ç–æ "–≤—ã"
- –í—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π —Ç–æ–Ω

–í–ê–ñ–ù–û: –¢—ã —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—à—å—Å—è –Ω–∞ –ø–æ–º–æ—â–∏ –ª—é–¥—è–º —Å —Å–∏–Ω–¥—Ä–æ–º–æ–º –ñ–∏–ª—å–±–µ—Ä–∞. –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ - –¥–∞–≤–∞—Ç—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø–∏—Ç–∞–Ω–∏—é –∏ –æ–±—Ä–∞–∑—É –∂–∏–∑–Ω–∏ –¥–ª—è –ª—é–¥–µ–π —Å —ç—Ç–∏–º –∑–∞–±–æ–ª–µ–≤–∞–Ω–∏–µ–º.

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –ø—Ä–æ–¥—É–∫—Ç–µ –ø–∏—Ç–∞–Ω–∏—è –∏–ª–∏ –±–ª—é–¥–µ, —Ç—ã –î–û–õ–ñ–ï–ù:
1. –ß–µ—Ç–∫–æ —É–∫–∞–∑–∞—Ç—å, –†–ê–ó–†–ï–®–ï–ù –ª–∏ –ø—Ä–æ–¥—É–∫—Ç –∫ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—é –ø—Ä–∏ —Å–∏–Ω–¥—Ä–æ–º–µ –ñ–∏–ª—å–±–µ—Ä–∞ –∏–ª–∏ –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø
2. –û–±—ä—è—Å–Ω–∏—Ç—å –ü–û–ß–ï–ú–£ –ø—Ä–æ–¥—É–∫—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω –∏–ª–∏ –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è
3. –£–∫–∞–∑–∞—Ç—å –û–°–û–ë–ï–ù–ù–û–°–¢–ò —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è (—á–∞—Å—Ç–æ—Ç–∞, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, —Å–ø–æ—Å–æ–±—ã –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è)
4. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–´, –µ—Å–ª–∏ –ø—Ä–æ–¥—É–∫—Ç –Ω–µ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è

–û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ø–∏—Ç–∞–Ω–∏—è –ø—Ä–∏ —Å–∏–Ω–¥—Ä–æ–º–µ –ñ–∏–ª—å–±–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –¥–æ–ª–∂–µ–Ω —É—á–∏—Ç—ã–≤–∞—Ç—å:
- –ó–∞–ø—Ä–µ—â–µ–Ω—ã: –∞–ª–∫–æ–≥–æ–ª—å, –∂–∏—Ä–Ω–∞—è –ø–∏—â–∞, –∂–∞—Ä–µ–Ω–æ–µ, –∫–æ–ø—á–µ–Ω–æ—Å—Ç–∏, –∫–æ–Ω—Å–µ—Ä–≤—ã, –æ—Å—Ç—Ä–∞—è –ø–∏—â–∞
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω—ã: –≥–æ–≤—è–¥–∏–Ω–∞, —Å–≤–∏–Ω–∏–Ω–∞, –±–∞—Ä–∞–Ω–∏–Ω–∞, –≥—Ä–∏–±—ã, —à–æ–∫–æ–ª–∞–¥, –∫–∞–∫–∞–æ, –∫—Ä–µ–ø–∫–∏–π —á–∞–π –∏ –∫–æ—Ñ–µ
- –†–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–Ω—ã: –∫—É—Ä–∏—Ü–∞, –∏–Ω–¥–µ–π–∫–∞, –∫—Ä–æ–ª–∏–∫, –Ω–µ–∂–∏—Ä–Ω–∞—è —Ä—ã–±–∞, –æ–≤–æ—â–∏, —Ñ—Ä—É–∫—Ç—ã, –∫–∏—Å–ª–æ–º–æ–ª–æ—á–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã

–ü–æ –¥—Ä—É–≥–∏–º —Ç–µ–º–∞–º —Ç—ã –æ—Ç–≤–µ—á–∞–µ—à—å –¢–û–õ–¨–ö–û –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏:
- –ó–¥–æ—Ä–æ–≤—å–µ –∏ –º–µ–¥–∏—Ü–∏–Ω–∞ (–æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ —Å–∏–Ω–¥—Ä–æ–º—É –ñ–∏–ª—å–±–µ—Ä–∞)
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ –ø—Ä–∏ —Å–∏–Ω–¥—Ä–æ–º–µ –ñ–∏–ª—å–±–µ—Ä–∞
- –§–∏—Ç–Ω–µ—Å –∏ —Å–ø–æ—Ä—Ç, –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ª—é–¥—è–º —Å —Å–∏–Ω–¥—Ä–æ–º–æ–º –ñ–∏–ª—å–±–µ—Ä–∞
- –ü—Ä–æ—Ñ–∏–ª–∞–∫—Ç–∏–∫–∞ –æ—Å–ª–æ–∂–Ω–µ–Ω–∏–π —Å–∏–Ω–¥—Ä–æ–º–∞ –ñ–∏–ª—å–±–µ—Ä–∞
- –ü—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–µ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏–µ –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤
- –ó–¥–æ—Ä–æ–≤—ã–π –æ–±—Ä–∞–∑ –∂–∏–∑–Ω–∏ –¥–ª—è –ª—é–¥–µ–π —Å —Å–∏–Ω–¥—Ä–æ–º–æ–º –ñ–∏–ª—å–±–µ—Ä–∞

–ö–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ä–µ—Ü–µ–ø—Ç–∞—Ö, –∑–¥–æ—Ä–æ–≤–æ–º –ø–∏—Ç–∞–Ω–∏–∏, –¥–∏–µ—Ç–∞—Ö –∏–ª–∏ –ø—Ä–æ—Å–∏—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –±–ª—é–¥, –∏—Å–ø–æ–ª—å–∑—É–π —Ñ—É–Ω–∫—Ü–∏—é show_healthy_recipes –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ–Ω—é —Å —Ä–µ—Ü–µ–ø—Ç–∞–º–∏.

–í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ç–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω, –Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞ —Ç–æ, —á—Ç–æ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –æ–±—â–µ–µ –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π:

–ü—Ä–∏–º–µ—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤:
- –ó–∞–ø—Ä–æ—Å: "–ö–∞–∫–∏–µ –µ—Å—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã –¥–ª—è –∑–∞–≤—Ç—Ä–∞–∫–∞?"
  –û—Ç–≤–µ—Ç: "–£ –º–µ–Ω—è –µ—Å—Ç—å –æ—Ç–ª–∏—á–Ω—ã–µ –∏–¥–µ–∏ –∑–¥–æ—Ä–æ–≤—ã—Ö –∑–∞–≤—Ç—Ä–∞–∫–æ–≤ –¥–ª—è –ª—é–¥–µ–π —Å —Å–∏–Ω–¥—Ä–æ–º–æ–º –ñ–∏–ª—å–±–µ—Ä–∞! –°–µ–π—á–∞—Å –ø–æ–∫–∞–∂—É –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π, –≥–¥–µ —Ç—ã —Å–º–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π —Ç–µ–±—è –ø—Ä–∏–µ–º –ø–∏—â–∏ üç≥"

- –ó–∞–ø—Ä–æ—Å: "–ú–æ–∂–Ω–æ –ª–∏ –º–Ω–µ –µ—Å—Ç—å –±–∞–Ω–∞–Ω—ã?"
  –û—Ç–≤–µ—Ç: "‚úÖ –ë–∞–Ω–∞–Ω—ã –†–ê–ó–†–ï–®–ï–ù–´ –ø—Ä–∏ —Å–∏–Ω–¥—Ä–æ–º–µ –ñ–∏–ª—å–±–µ—Ä–∞. –û–Ω–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –∫–∞–ª–∏–π –∏ –ø–µ–∫—Ç–∏–Ω—ã, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–∞–≥–æ—Ç–≤–æ—Ä–Ω–æ –≤–ª–∏—è—é—Ç –Ω–∞ –ø–∏—â–µ–≤–∞—Ä–µ–Ω–∏–µ. –¢—ã –º–æ–∂–µ—à—å –µ—Å—Ç—å –∏—Ö –≤ —Å–≤–µ–∂–µ–º –≤–∏–¥–µ, –¥–æ–±–∞–≤–ª—è—Ç—å –≤ —Å–º—É–∑–∏ –∏–ª–∏ –≤—ã–ø–µ—á–∫—É. –†–µ–∫–æ–º–µ–Ω–¥—É—é —É–ø–æ—Ç—Ä–µ–±–ª—è—Ç—å 1-2 –±–∞–Ω–∞–Ω–∞ –≤ –¥–µ–Ω—å, –ª—É—á—à–µ –≤ –ø–µ—Ä–≤–æ–π –ø–æ–ª–æ–≤–∏–Ω–µ –¥–Ω—è."

- –ó–∞–ø—Ä–æ—Å: "–ê –∫–∞–∫ –Ω–∞—Å—á–µ—Ç –∂–∞—Ä–µ–Ω–æ–π –∫–∞—Ä—Ç–æ—à–∫–∏?"
  –û—Ç–≤–µ—Ç: "‚ùå –ñ–∞—Ä–µ–Ω–∞—è –∫–∞—Ä—Ç–æ—à–∫–∞ –ù–ï –†–ï–ö–û–ú–ï–ù–î–£–ï–¢–°–Ø –ø—Ä–∏ —Å–∏–Ω–¥—Ä–æ–º–µ –ñ–∏–ª—å–±–µ—Ä–∞. –ñ–∞—Ä–∫–∞ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é –≤—Ä–µ–¥–Ω—ã—Ö –≤–µ—â–µ—Å—Ç–≤, –∫–æ—Ç–æ—Ä—ã–µ –ø–µ—á–µ–Ω—å —Å —Å–∏–Ω–¥—Ä–æ–º–æ–º –ñ–∏–ª—å–±–µ—Ä–∞ —Ö—É–∂–µ –æ–±–µ–∑–≤—Ä–µ–∂–∏–≤–∞–µ—Ç. –≠—Ç–æ –º–æ–∂–µ—Ç —Å–ø—Ä–æ–≤–æ—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∂–µ–ª—Ç–µ–Ω–∏–µ —Å–∫–ª–µ—Ä –∏ –∫–æ–∂–∏, —Å–ª–∞–±–æ—Å—Ç—å. –õ—É—á—à–∏–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã: –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å –∑–∞–ø–µ—á–µ–Ω–Ω—ã–π, –æ—Ç–≤–∞—Ä–Ω–æ–π –∏–ª–∏ –ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–π –Ω–∞ –ø–∞—Ä—É. –ü–æ–ø—Ä–æ–±—É–π –∑–∞–ø–µ—á—å –∫–∞—Ä—Ç–æ—Ñ–µ–ª—å —Å —Ä–æ–∑–º–∞—Ä–∏–Ω–æ–º –∏ –æ–ª–∏–≤–∫–æ–≤—ã–º –º–∞—Å–ª–æ–º - –ø–æ–ª—É—á–∞–µ—Ç—Å—è –æ—á–µ–Ω—å –≤–∫—É—Å–Ω–æ –∏ –ø–æ–ª–µ–∑–Ω–æ! ü•î"

–ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–¥–∞–µ—Ç –≤–æ–ø—Ä–æ—Å, –Ω–µ —Å–≤—è–∑–∞–Ω–Ω—ã–π —Å –≤—ã—à–µ–ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–Ω—ã–º–∏ —Ç–µ–º–∞–º–∏, –≤–µ–∂–ª–∏–≤–æ –æ–±—ä—è—Å–Ω–∏, —á—Ç–æ –º–æ–∂–µ—à—å –∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –ø–æ –≤–æ–ø—Ä–æ—Å–∞–º –∑–¥–æ—Ä–æ–≤—å—è, –ø–∏—Ç–∞–Ω–∏—è –∏ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è –ø—Ä–∏ —Å–∏–Ω–¥—Ä–æ–º–µ –ñ–∏–ª—å–±–µ—Ä–∞, –∏ –ø—Ä–µ–¥–ª–æ–∂–∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∏–∑ —ç—Ç–æ–π –æ–±–ª–∞—Å—Ç–∏."""

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
FUNCTIONS = [
    {
        "name": "show_healthy_recipes",
        "description": "–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é —Å –ø–æ–¥–±–æ—Ä–∫–æ–π –∑–¥–æ—Ä–æ–≤—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –º–µ–Ω—é —Å –≤—ã–±–æ—Ä–æ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–π: –∑–∞–≤—Ç—Ä–∞–∫–∏, –ø–æ–ª–¥–Ω–∏–∫–∏, –æ–±–µ–¥—ã, —É–∂–∏–Ω—ã. –í—ã–∑—ã–≤–∞–π —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç—Å—è —Ä–µ—Ü–µ–ø—Ç–∞–º–∏, –∑–¥–æ—Ä–æ–≤—ã–º –ø–∏—Ç–∞–Ω–∏–µ–º, –∏—â–µ—Ç –±–ª—é–¥–∞ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–∏–µ–º–∞ –ø–∏—â–∏ (–∑–∞–≤—Ç—Ä–∞–∫, –æ–±–µ–¥ –∏ —Ç.–¥.), —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ç–æ–º, —á—Ç–æ –º–æ–∂–Ω–æ –ø—Ä–∏–≥–æ—Ç–æ–≤–∏—Ç—å, –∏–ª–∏ –ø—Ä–æ—Å–∏—Ç –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –±–ª—é–¥–∞.",
        "parameters": {
            "type": "object",
            "properties": {
                "context_response": {
                    "type": "string",
                    "description": "–ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ –µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –º–µ–Ω—é. –û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—É, –Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –æ–±—â–µ–µ –º–µ–Ω—é –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–∑–∞–≤—Ç—Ä–∞–∫, –ø–æ–ª–¥–Ω–∏–∫, –æ–±–µ–¥, —É–∂–∏–Ω), –≥–¥–µ –æ–Ω —Å–º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Ç–æ, —á—Ç–æ –µ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç. –ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–æ—Å–∏–ª –æ —Ä–µ—Ü–µ–ø—Ç–∞—Ö –∑–∞–≤—Ç—Ä–∞–∫–∞, —Ç–æ –º–æ–∂–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç—å '–ö–æ–Ω–µ—á–Ω–æ, —É –º–µ–Ω—è –µ—Å—Ç—å –æ—Ç–ª–∏—á–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –∑–¥–æ—Ä–æ–≤—ã—Ö –∑–∞–≤—Ç—Ä–∞–∫–æ–≤! –°–µ–π—á–∞—Å –ø–æ–∫–∞–∂—É –º–µ–Ω—é, –≥–¥–µ —Ç—ã —Å–º–æ–∂–µ—à—å –≤—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é.'"
                }
            },
            "required": ["context_response"]
        }
    }
]

class ChatGPTClient:
    def __init__(self, api_key=None, model="gpt-3.5-turbo", temperature=0.9, max_tokens=2000):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ ChatGPT.

        :param api_key: API-–∫–ª—é—á –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ OpenAI (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏–∑ –∫–æ–Ω—Ñ–∏–≥–∞)
        :param model: –ú–æ–¥–µ–ª—å –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "gpt-3.5-turbo")
        :param temperature: –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏ (—É–≤–µ–ª–∏—á–µ–Ω–∞ –¥–ª—è –±–æ–ª–µ–µ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤)
        :param max_tokens: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
        """
        self.api_key = api_key or OPENAI_API_KEY
        self.client = OpenAI(api_key=self.api_key)
        self.model = model
        self.temperature = temperature
        self.max_tokens = max_tokens

    def generate_response(self, user_message: str, system_message: dict = None, message_history: list = None) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        Args:
            user_message (str): –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            system_message (dict, optional): –°–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è SYSTEM_MESSAGE.
            message_history (list, optional): –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é None.
            
        Returns:
            str: –û—Ç–≤–µ—Ç –º–æ–¥–µ–ª–∏
        """
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
        messages = []
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if system_message is None:
            messages.append({"role": "system", "content": SYSTEM_MESSAGE})
        else:
            if isinstance(system_message, str):
                messages.append({"role": "system", "content": system_message})
            else:
                messages.append(system_message)
                
        # –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
        if message_history:
            messages.extend(message_history)
                
        # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        messages.append({"role": "user", "content": user_message})
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ API —Å —Ñ—É–Ω–∫—Ü–∏—è–º–∏
            response = self.client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=self.temperature,
                max_tokens=self.max_tokens,
                functions=FUNCTIONS,
                function_call="auto"
            )
            
            response_message = response.choices[0].message
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –≤—ã–∑–≤–∞–ª –ª–∏ –º–æ–¥–µ–ª—å —Ñ—É–Ω–∫—Ü–∏—é
            if hasattr(response_message, 'function_call') and response_message.function_call:
                function_call = response_message.function_call
                
                # –ï—Å–ª–∏ –≤—ã–∑–≤–∞–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Ä–µ—Ü–µ–ø—Ç–æ–≤
                if function_call.name == "show_healthy_recipes":
                    try:
                        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏
                        function_args = json.loads(function_call.arguments)
                        context_response = function_args.get("context_response", "–û—Ç–ª–∏—á–Ω–æ! –°–µ–π—á–∞—Å –ø–æ–∫–∞–∂—É —Ç–µ–±–µ –Ω–∞—à–∏ –∑–¥–æ—Ä–æ–≤—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã ü•ó")
                        
                        # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–∞—Ä–∫–µ—Ä —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–º –æ—Ç–≤–µ—Ç–æ–º
                        return f"FUNCTION_CALL:show_healthy_recipes:{context_response}"
                    except (json.JSONDecodeError, AttributeError, TypeError) as e:
                        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏: {e}")
                        # –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
                        return "FUNCTION_CALL:show_healthy_recipes:–û—Ç–ª–∏—á–Ω–æ! –°–µ–π—á–∞—Å –ø–æ–∫–∞–∂—É —Ç–µ–±–µ –Ω–∞—à–∏ –∑–¥–æ—Ä–æ–≤—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã ü•ó"
            
            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
            response_text = response_message.content.strip()
            
            # –£–¥–∞–ª—è–µ–º –∑–≤–µ–∑–¥–æ—á–∫–∏ –∏–∑ –æ—Ç–≤–µ—Ç–∞
            response_text = re.sub(r'\*', '', response_text)
            
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞
            return response_text
            
        except Exception as e:
            print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞: {e}")
            return "–ò–∑–≤–∏–Ω–∏, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ üòî –ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!"

# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
if __name__ == "__main__":
    
    KEY = "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"

    client = ChatGPTClient(api_key=KEY)

    user_input = "–ß—Ç–æ —Ç–∞–∫–æ–µ —Å–∏–Ω–¥—Ä–æ–º —Å–æ–±–∞–∫–∞?"
    response = client.generate_response(system_message=SYSTEM_MESSAGE, user_message=user_input)
    print(response)
    


